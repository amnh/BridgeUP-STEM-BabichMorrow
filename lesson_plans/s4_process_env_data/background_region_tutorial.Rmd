---
title: "Environmental Background Regions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background extents in Maxent

In the Maxent model, we need to choose suitable background regions for each sloth species. The Maxent model compares the environmental conditions at our known sloth occurrence points with the environmental conditions in the background region to make its predictions. This also allows us to flag regions with environmental conditions outside the range of conditions used to build the model when we project our model to new geographic locations and time periods later on.

Our first step is to load in our occurrence data. Load the csv into R for the species you are working on:

```{r}

```

Next, load the following packages into R (you may need to install some of these first):
  + `rgeos`
  + `sp`
  + `raster`
  + `dismo`

```{r}

```


## Bounding box

The first type of background region we are going to be creating today is a bounding box: a rectangular region around the occurrence points. We have already talked about bounding boxes in the context of using them to create maps in R. Now we are going to use them as one of the methods to designate a background region for Maxent modeling.

To create the bounding box, we are going to use the `bbox()` function on the latitude and longitude columns of our torquatus data.

**Try it yourself:** Complete the following code by subsetting `torquatus` just to include the longitude and latitude columns. Also, add a line to plot the bounding box.

```{r}
# Create bounding box
bgExt <- bbox(as.matrix(torquatus[]))
# Convert bounding box to SpatialPolygon
bgExt <- as(extent(bgExt), "SpatialPolygons")
# Plot bounding box

```


### Mask the environmental data

Next we are going to use some functions from the `raster` package to mask our environmental data by the bounding box we created. Refer back to the `raster_tutorial.Rmd` to see how to use these functions.

**Try it yourself:** Crop the environmental variables by the bounding box. Plot the resulting area to see what region the bounding box covers.

```{r}
# Create cropped raster
envsBgCrop <- 
# Plot cropped raster

```

**Try it yourself:** Mask the MCP background extent shape from the cropped raster.

```{r}
# Create masked raster
envsBgMsk <-
# Plot masked raster

```


### Sample background points

Our final step is to use the masked region we created to sample random background points for MaxEnt. We are going to use the `randomPoints()` function from the `dismo` package to sample 10,000 points randomly from the region.

**Try it yourself:** Look at the Help menu for `randomPoints()`. You need to specify the first two arguments only (`mask` and `n`). Use the function to sample 10,000 points from the masked raster. Finally, convert these points into a dataframe.

```{r}
# Sample 10000 points from the bounding box
bg.xy <-
# Convert these points into a dataframe using as.data.frame
bg.xy <- 
```


### Buffering

We can "buffer" the bounding box to increase the size of the rectangle by a certain number of degrees. This can help include regions close to the "most extreme" points that should potentially also be included in the study region. We can use a function from the `rgeos` package called `gBuffer()` to accomplish this.

**Try it yourself:** Look at the Help menu for `gBuffer()`. You only need to worry about 2 of the arguments for the function (all others can be left at the defaults). Which two arguments do you need to specify? Create a new `bgExt_buffer` object buffered by 1 degree. Plot this new bounding box and compare it with the original one.

```{r}
# Create buffered MCP
bgExt_buffer <-
# Plot buffered MCP
  
```

**Try it yourself:** Now go through the same cropping and masking procedure as above to create an environmental raster for your study region:

```{r}

```


**Try it yourself:** Play around with some other buffer values. How does this change the background region?

## Minimum convex polygon

The minimum convex polygon method draws the smallest polygon around the occurrence points where all angles of the polygon are acute (less than 180Â°). To create the minimum convex polygon, we are going to create a function called `mcp()`.

**Try it yourself:** The `mcp()` function has already been written for you, but look over it to try to understand each line. Some of this code should look familiar to you from our section on Spatial objects in R.

```{r}
# function to create a minimum convex polygon
mcp <- function(xy) {
  # convert the input coordinates into a spatial object
  xy <- as.data.frame(sp::coordinates(xy))
  # find the subset of occurrence points that lie on the convex hull around all of the points
  coords.t <- chull(xy[, 1], xy[, 2])
  xy.bord <- xy[coords.t, ]
  xy.bord <- rbind(xy.bord[nrow(xy.bord), ], xy.bord)
  # make a SpatialPolygon out of the convex polygon
  return(sp::SpatialPolygons(list(sp::Polygons(list(sp::Polygon(as.matrix(xy.bord))), 1))))
}
```

Our next step is to run this function on our data to create the minimum convex polygon (MCP).

**Try it yourself:** Create a polygon called `bgExt` by providing it with your occurrence data (just the latitude and longitude columns!). Hint, you may need to subset out only the columns you need.

```{r}
# Create the minimum convex polygon
bgExt <- 
# Plot the minimum convex polygon

```

### Mask the environmental data

You can follow the same process as you did with the bounding box to crop and mask the environmental rasters by the MCP.

**Try it yourself:** Crop the environmental variables by the MCP you created. Plot the resulting area to see what region the MCP covers.

```{r}
# Create cropped raster
envsBgCrop <- 
# Plot cropped raster

```

**Try it yourself:** Mask the MCP background extent shape from the cropped raster.

```{r}
# Create masked raster
envsBgMsk <-
# Plot masked raster

```

### Sample background points

Just as with the bounding box, our final step is to sample 10000 background points from the MCP.

**Try it yourself:** Sample 10,000 points from the masked raster.

```{r}
# Sample 10000 points from the MCP
bg.xy <-
# Convert these points into a dataframe using as.data.frame
bg.xy <- 
```


### Buffering

Just like bounding boxes, minimum convex polygons can be buffered in the same way.

**Try it yourself:** Create a new `bgExt_buffer` object buffered by 1 degree. Plot this new MCP and compare it with the original one.

```{r}
# Create buffered MCP
bgExt_buffer <-
# Plot buffered MCP
  
```

**Try it yourself:** Now go through the same cropping and masking procedure as above to create an environmental raster for your study region:

```{r}

```


**Try it yourself:** Play around with some other buffer values. How does this change the background region?

## Point buffers

The third method of designating a study region is by creating a buffered region around each occurrence point. You can think of this as creating a bunch of circles of a given diameter (the buffer distance) around each occurrence point. To create this kind of background region, you can use the `gBuffer()` function directly on the occurrence points.

**Try it yourself:** First, we need to convert the occurrence points to a Spatial object using the `SpatialPoints()` function (this may look familiar from our GPS in R lessons).

```{r}
# Create SpatialPoints object
occs.sp <- 
```

**Try it yourself:** Now we can buffer this object in the same way you buffered the bounding box and MCP. Start by buffering the points by 1 degree and go through the environmental masking and background sampling process as you did for the other background regions.

```{r}
# Create buffered points background extent
bgExt <-
# Create cropped raster
envsBgCrop <- 
# Plot cropped raster
  
# Create masked raster
envsBgMsk <-
# Plot masked raster

# Sample 10000 points from the MCP
bg.xy <-
# Convert these points into a dataframe using as.data.frame
bg.xy <- 
```

**Try it yourself:** Try out some other buffering distances for this method as well.
